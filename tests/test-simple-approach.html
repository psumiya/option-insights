<!DOCTYPE html>
<html>
<head>
  <title>Simple Robinhood P/L Calculation</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      max-width: 1200px;
      margin: 0 auto;
    }
    .upload { 
      padding: 20px; 
      background: #f5f5f5; 
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { background: #45a049; }
    .result {
      padding: 20px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin: 10px 0;
    }
    .big-number {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }
    .positive { color: #4CAF50; }
    .negative { color: #f44336; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f5f5f5;
      font-weight: bold;
    }
    .excluded {
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Simple Robinhood P/L Calculation</h1>
  
  <div class="upload">
    <h3>Upload Robinhood CSV</h3>
    <input type="file" id="fileInput" accept=".csv">
    <button onclick="calculate()">Calculate P/L</button>
  </div>
  
  <div id="output"></div>
  
  <script>
    function parseAmount(amountStr) {
      if (!amountStr) return 0;
      let cleaned = amountStr.replace(/[$,]/g, '');
      if (cleaned.includes('(') || cleaned.includes(')')) {
        cleaned = cleaned.replace(/[()]/g, '');
        return -parseFloat(cleaned);
      }
      return parseFloat(cleaned);
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }
    
    async function calculate() {
      const output = document.getElementById('output');
      output.innerHTML = '<p>Processing...</p>';
      
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        output.innerHTML = '<p style="color:red">Please select a CSV file first</p>';
        return;
      }
      
      try {
        const csvText = await file.text();
        const lines = csvText.trim().split('\n');
        
        // Parse header
        const headers = parseCSVLine(lines[0]);
        
        // Parse all rows
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line || line.startsWith('""')) continue;
          
          const values = parseCSVLine(line);
          const row = {};
          headers.forEach((h, idx) => {
            row[h] = values[idx] || '';
          });
          rows.push(row);
        }
        
        console.log('Total rows:', rows.length);
        
        // Step 2: Filter out non-trading transactions
        const excludedDescriptions = [
          'ACH Deposit',
          'ACH Withdrawal', 
          'Cash reward',
          'Interest Payment',
          'Gold Deposit Boost Payment',
          'Gold Plan Credit',
          'Gold Subscription Fee'
        ];
        
        const tradingRows = rows.filter(row => {
          const desc = row['Description'] || '';
          return !excludedDescriptions.some(excluded => desc.includes(excluded));
        });
        
        console.log('Trading rows (after filtering):', tradingRows.length);
        console.log('Excluded rows:', rows.length - tradingRows.length);
        
        // Step 3: Group by Instrument
        const byInstrument = new Map();
        tradingRows.forEach(row => {
          const instrument = row['Instrument'];
          if (!instrument) return;
          
          if (!byInstrument.has(instrument)) {
            byInstrument.set(instrument, []);
          }
          byInstrument.get(instrument).push(row);
        });
        
        console.log('Unique instruments:', byInstrument.size);
        
        // Step 4: For each instrument, group by Description and sum amounts
        const tradeResults = [];
        let totalPL = 0;
        
        byInstrument.forEach((rows, instrument) => {
          const byDescription = new Map();
          
          rows.forEach(row => {
            const desc = row['Description'];
            if (!desc) return;
            
            if (!byDescription.has(desc)) {
              byDescription.set(desc, {
                description: desc,
                transactions: [],
                totalAmount: 0
              });
            }
            
            const amount = parseAmount(row['Amount']);
            const trade = byDescription.get(desc);
            trade.transactions.push({
              date: row['Activity Date'],
              code: row['Trans Code'],
              qty: row['Quantity'],
              amount: amount
            });
            trade.totalAmount += amount;
          });
          
          // Add each unique description as a trade
          byDescription.forEach(trade => {
            tradeResults.push({
              instrument: instrument,
              description: trade.description,
              transactionCount: trade.transactions.length,
              totalAmount: trade.totalAmount,
              transactions: trade.transactions
            });
            totalPL += trade.totalAmount;
          });
        });
        
        // Sort by total amount
        tradeResults.sort((a, b) => a.totalAmount - b.totalAmount);
        
        // Display results
        let html = '<div class="result">';
        html += '<h2>Results</h2>';
        html += `<p><strong>Total Rows:</strong> ${rows.length}</p>`;
        html += `<p><strong>Excluded (non-trading):</strong> ${rows.length - tradingRows.length}</p>`;
        html += `<p><strong>Trading Rows:</strong> ${tradingRows.length}</p>`;
        html += `<p><strong>Unique Trades:</strong> ${tradeResults.length}</p>`;
        html += `<div class="big-number ${totalPL >= 0 ? 'positive' : 'negative'}">Total P/L: $${totalPL.toFixed(2)}</div>`;
        html += `<p><strong>Expected (Robinhood):</strong> -$3,859.00</p>`;
        html += `<p><strong>Difference:</strong> $${(totalPL - (-3859)).toFixed(2)}</p>`;
        html += '</div>';
        
        // Show breakdown by instrument
        html += '<div class="result">';
        html += '<h2>P/L by Instrument</h2>';
        const byInstrumentPL = new Map();
        tradeResults.forEach(t => {
          byInstrumentPL.set(t.instrument, (byInstrumentPL.get(t.instrument) || 0) + t.totalAmount);
        });
        
        html += '<table><tr><th>Instrument</th><th>P/L</th></tr>';
        Array.from(byInstrumentPL.entries())
          .sort((a, b) => a[1] - b[1])
          .forEach(([inst, pl]) => {
            html += `<tr><td>${inst}</td><td class="${pl >= 0 ? 'positive' : 'negative'}">$${pl.toFixed(2)}</td></tr>`;
          });
        html += '</table>';
        html += '</div>';
        
        // Show all trades
        html += '<div class="result">';
        html += '<h2>All Trades (sorted by P/L)</h2>';
        html += '<table>';
        html += '<tr><th>Instrument</th><th>Description</th><th>Transactions</th><th>P/L</th></tr>';
        tradeResults.forEach(t => {
          html += `<tr>`;
          html += `<td>${t.instrument}</td>`;
          html += `<td>${t.description}</td>`;
          html += `<td>${t.transactionCount}</td>`;
          html += `<td class="${t.totalAmount >= 0 ? 'positive' : 'negative'}">$${t.totalAmount.toFixed(2)}</td>`;
          html += `</tr>`;
        });
        html += '</table>';
        html += '</div>';
        
        output.innerHTML = html;
        
      } catch (error) {
        output.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
        console.error(error);
      }
    }
  </script>
</body>
</html>
